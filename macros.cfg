# ðŸ§© Chamada da macro no slicer (Cura ou similar):
# START_PRINT BED_TEMP={material_bed_temperature_layer_0} EXTRUDER_TEMP={material_print_temperature_layer_0} FILAMENT={material_name} NOZZLE={machine_nozzle_size} WIDTH={line_width}
# ðŸ§© No OrcaSlicer/PrusaSlicer/SuperSlicer
# START_PRINT BED_TEMP=[first_layer_bed_temperature] EXTRUDER_TEMP=[first_layer_temperature] FILAMENT=[filament_type] NOZZLE=[nozzle_diameter] WIDTH=[line_width]
[gcode_macro START_PRINT]
description: "Start da Ender 3 S1 Plus com purga lateral adaptavel"
gcode:
  ; PARAMETROS CONFIGURÃVEIS - Recebidos do slicer
  {% set x = params.X|default(5)|float %}  ; posiÃ§Ã£o inicial X da purga
  {% set y = params.Y|default(10)|float %}  ; posiÃ§Ã£o inicial Y da purga
  {% set length = params.LEN|default(100)|float %}  ; comprimento da linha de purga
  {% set line_height = params.LINE_HEIGHT|default(0.2)|float %}  ; altura da linha (primeira camada)
  {% set width = params.WIDTH|default(0.45)|float %}  ; largura de linha definida no slicer
  {% set bed = params.BED_TEMP|default(60)|float %}  ; temperatura da cama
  {% set extruder = params.EXTRUDER_TEMP|default(200)|float %}  ; temperatura do bico
  {% set material = params.FILAMENT|default("Desconhecido") %}  ; tipo de filamento
  {% set rep = params.REPS|default(3)|int %}  ; quantidade de linhas de purga
  {% set z_safety = params.z_safety|default(0.1)|float %}  ; altura extra para seguranÃ§a
  {% set z_off = params.z_offset|default(0.0)|float %}  ; offset Z da sonda (Klipper fornece em runtime)
  {% set z_height = z_off + z_safety %}  ; altura final de purga
  {% set nozzle = params.NOZZLE|default(0.4)|float %}  ; diametro do bico
  {% set feedrate = params.FEED|default(1000)|float %}  ; velocidade de extrusao mm/min
  {% set spacing_factor = 1.10 %}  ; fator de espacamento entre linhas 10% extra
  {% set line_spacing = width * spacing_factor %}  ; espacamento calculado
  {% set area_filamento = 2.405 %}  ; area de filamento 1.75mmÂ² (Ï€rÂ²)
  {% set Ecalc = ((width * line_height * length) / area_filamento)|round(2) %}  ; extrusao calculada
  M117 Iniciando impressao
  ; INFORMACOES INICIAIS PARA CONFERENCIA (material/bico/largura/altura)
  M117 Verificar: Mat {material} Bico {nozzle} Larg {width} Alt {line_height}
  RESPOND TYPE=echo MSG="START_PRINT: Mat={material}, Bico={nozzle}mm, Larg={width}mm, AltCam={line_height}mm"
  ; PRE-AQUECIMENTO INICIAL
  M117 Aquecendo mesa: {bed}C
  M104 S150  ; aquecer bico ate 150C para homing seguro
  M140 S{bed}  ; iniciar aquecimento da mesa
  M190 S{bed}  ; aguardar mesa atingir temperatura
  M104 S150  ; manter hotend aquecido
  ; HOMING E NIVELAMENTO
  M117 Executando homing
  G28  ; home total
  G90  ; coordenadas absolutas
  M83  ; extrusao relativa ESSENCIAL
  BED_MESH_CLEAR  ; limpar malha anterior
  BED_MESH_PROFILE LOAD=default  ; carregar malha salva
  ; PRE-AQUECIMENTO INTERMEDIARIO para acelerar
  M104 S170  ; pre-aquecimento rapido a 170C
  M117 Aquecendo bico: {extruder}C
  ; AQUECIMENTO FINAL DO HOTEND
  M104 S{extruder}  ; iniciar aquecimento final do bico
  M109 S{extruder}  ; aguardar bico atingir temperatura final
  ; PURGA LATERAL (IDA + VOLTA)
  M117 Iniciando purga lateral
  G92 E0  ; zerar contador de extrusao
  G90  ; modo absoluto
  G1 Z{z_height} F3000  ; subir para altura de purga
  G1 X{x} Y{y} F6000  ; ir para posicao inicial de purga
  {% for i in range(rep) %}  ; repetir linhas de purga
      {% set cur_x = x + i * line_spacing %}  ; calcular posicao X desta repeticao
      M117 Purga {i+1}/{rep}
      G1 X{cur_x} Y{y} F3000  ; deslocar X para linha atual
      G1 E2 F300  ; pressurizar bico antes de iniciar
      G1 Y{y + length} E{Ecalc|round(2)} F{feedrate}  ; ida da purga com extrusao
      G1 Y{y} E{Ecalc|round(2)} F{feedrate}  ; volta da purga com extrusao
      G1 E-0.8 F1800  ; pequena retracao
  {% endfor %}
  ; FINALIZACAO DA PURGA
  M117 Finalizando purga
  G1 E-1.0 F1800  ; retracao antes de mover
  G92 E0  ; zerar extrusor apos retracao
  G1 Z{z_height + 2} F1500  ; subir para evitar raspar
  G1 X5 Y5 F3000  ; ir para canto frontal
  ; PREPARAR VARIÃVEIS PARA END_PRINT
  SET_GCODE_VARIABLE MACRO=END_PRINT VARIABLE=ultimo_material VALUE='"{material}"'
  SET_GCODE_VARIABLE MACRO=END_PRINT VARIABLE=ultimo_nozzle VALUE={nozzle}
  SET_GCODE_VARIABLE MACRO=END_PRINT VARIABLE=ultima_largura VALUE={width}
  M117 Iniciada: {material} | Bico {nozzle} | Larg {width} | Alt {line_height}
  RESPOND TYPE=echo MSG="PRINT: Mat={material}, Bico={nozzle}mm, Larg={width}mm, AltCam={line_height}mm"

[gcode_macro END_PRINT]
description: "Rotina de finalizacao segura da Ender 3 S1 Plus"
variable_ultimo_material: "Desconhecido"
variable_ultimo_nozzle: 0.4
variable_ultima_largura: 0.45
gcode:
  M117 Finalizando impressao
  {action_respond_info('Finalizando impressao com material ' ~ ultimo_material)}
  ; DESLIGAR AQUECEDORES E VENTILADOR
  M400  ; aguardar conclusao dos movimentos
  M140 S0  ; desligar aquecimento da mesa
  M104 S0  ; desligar aquecimento do bico
  M107  ; desligar ventilador de peca
  ; RETRACAO FINAL E PREPARACAO
  G91  ; modo relativo
  G1 E-3 F1800  ; retracao leve do filamento
  G90  ; volta ao modo absoluto
  ; CALCULAR POSICAO SEGURA DE ESTACIONAMENTO
  ; No Klipper runtime: obtem valores reais; em teste local: usa padroes
  {% set printer_mock = printer|default({'toolhead': {'axis_maximum': {'z': 300}, 'position': {'z': 50}}}) %}
  {% set max_z = printer_mock.toolhead.axis_maximum.z|int %}
  {% set z_now = printer_mock.toolhead.position.z|float %}
  {% set print_area_x = 300 %}  ; area de impressao real X
  {% set print_area_y = 300 %}  ; area de impressao real Y
  {% set safe_raise = 100.0 %}  ; altura segura para elevar a peca
  {% set z_threshold = max_z * 0.66 %}  ; limiar 2/3 da altura maxima
  ; ESTACIONAR PECA CONFORME ALTURA
  {% if z_now > z_threshold %}  ; se peca esta alta
      {% set park_z = z_now + 10 %}  ; elevar apenas 10mm
      {% if park_z > max_z %}  ; se ultrapassa altura maxima
          {% set park_z = max_z %}  ; usar altura maxima
      {% endif %}
      G1 Z{park_z} F2000  ; elevar bico
      G1 X{print_area_x/2} Y{print_area_y - 10} F6000  ; ir para centro frontal da area de impressao
      {action_respond_info('Peca alta - finalizada com ' ~ ultimo_material)}
  {% else %}  ; se peca esta baixa
      {% set park_z = z_now + safe_raise %}  ; elevar 100mm
      {% if park_z > max_z %}  ; se ultrapassa altura maxima
          {% set park_z = max_z %}  ; usar altura maxima
      {% endif %}
      G1 Z{park_z} F2000  ; elevar bico
      G1 X{print_area_x - 10} Y{print_area_y - 10} F6000  ; ir para canto traseiro da area de impressao
      {action_respond_info('Impressao finalizada peca baixa')}
  {% endif %}
  ; LIBERAR MOTORES E FINALIZAR
  M84 X Y E  ; desligar motores X, Y e E
  {action_respond_info('END_PRINT concluido - Material: ' ~ ultimo_material ~ ' Nozzle: ' ~ ultimo_nozzle|string)}

[gcode_macro parafusos]
description: Ajustando os parafusos de nivelamento da cama
gcode:
  G28 ; home all axis and restore leveling
  BED_SCREWS_ADJUST

[gcode_macro parafusos_auto]
description: Ajustando os parafusos de nivelamento da cama automaticamente
gcode:
  G28 ; home all axis and restore leveling
  SCREWS_TILT_CALCULATE

[gcode_macro z_offset]
description: Calibrar a altura do Z offset
gcode:
  G28 ; home all axis and restore leveling
  PROBE_CALIBRATE


######################################################################
# Filament Change
######################################################################

# M600: Filament Change. This macro will pause the printer, move the
# tool to the change position, and retract the filament 50mm. Adjust
# the retraction settings for your own extruder. After filament has
# been changed, the print can be resumed from its previous position
# with the "RESUME" gcode.
[pause_resume]
[gcode_macro M600]
description: "Troca de filamento com nozzle e cama aquecidos"
gcode:
  {% set X = params.X|default(50)|float %}
  {% set Y = params.Y|default(0)|float %}
  {% set Z = params.Z|default(50)|float %}
  ; SALVAR ESTADO ATUAL
  SAVE_GCODE_STATE NAME=M600_state
  ; OBTER TEMPERATURAS ATUAIS ANTES DE PAUSAR
  {% set bed_temp = printer.heater_bed.target %}
  {% set hotend_temp = printer.extruder.target %}
  ; PREPARAR PARA PAUSA (mantem aquecimento ativo)
  M117 Pausando para trocar filamento
  PAUSE NO_HEAT=0
  ; RETRACAO INICIAL DO FILAMENTO
  G91
  G1 E-.8 F2700
  G1 Z{Z}
  G90
  ; IR PARA POSICAO DE TROCA
  G1 X{X} Y{Y} F3000
  ; RETRACAO COMPLETA
  G91
  G1 E-50 F1000
  G90
  ; MENSAGEM PARA O USUARIO
  M117 Filamento retirado - Insira novo filamento
  {action_respond_info('FILAMENT CHANGE: Nozzle aquecido a ' ~ hotend_temp ~ 'C e cama a ' ~ bed_temp ~ 'C')}
  ; QUANDO USUARIO DIZ RESUME: Recarregar filamento automaticamente
  G91
  G1 E100 F300  ; extrude novo filamento (ajuste conforme necessario)
  G90
  ; RESTAURAR ESTADO ORIGINAL
  RESTORE_GCODE_STATE NAME=M600_state
  M117 Filamento trocado - Impressao retomada
  {action_respond_info('Filamento carregado - Impressao retomada')}

######################################################################
# Mainsail Client Variables - Customizacao de PAUSE/RESUME
######################################################################
[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos   : True  ; usar posicoes customizadas
variable_custom_park_x    : 10.0  ; posicao X para pause (canto frontal esquerdo)
variable_custom_park_y    : 10.0  ; posicao Y para pause
variable_custom_park_dz   : 10.0  ; elevar Z em 10mm ao pausar
variable_retract          : 1.0   ; retracao ao pausar (mm)
variable_cancel_retract   : 5.0   ; retracao ao cancelar (mm)
variable_speed_retract    : 35.0  ; velocidade de retracao (mm/s)
variable_unretract        : 1.0   ; desretrair ao retomar (mm)
variable_speed_unretract  : 35.0  ; velocidade de desretracao (mm/s)
variable_speed_hop        : 15.0  ; velocidade de movimento Z (mm/s)
variable_speed_move       : 100.0 ; velocidade de movimento XY (mm/s)
variable_park_at_cancel   : True  ; mover para park ao cancelar
variable_park_at_cancel_x : None  ; usar custom_park_x
variable_park_at_cancel_y : None  ; usar custom_park_y
variable_use_fw_retract   : False ; nao usar firmware retraction
variable_idle_timeout     : 1800  ; timeout de 30 minutos (1800s) para manter aquecedores durante pause
variable_runout_sensor    : "filament_switch_sensor filament_sensor" ; sensor de filamento
variable_user_pause_macro : ""    ; macro customizada ao pausar
variable_user_resume_macro: ""    ; macro customizada ao retomar
variable_user_cancel_macro: ""    ; macro customizada ao cancelar
gcode:

######################################################################
# Macros de Manutencao - Load/Unload Filamento
######################################################################
[gcode_macro LOAD_FILAMENT]
description: Carregar filamento manualmente
gcode:
  {% set TEMP = params.TEMP|default(200)|float %}
  M117 Aquecendo para carregar filamento
  M109 S{TEMP}  ; aquecer a temperatura especificada
  M117 Carregando filamento
  M83  ; extrusao relativa
  G1 E50 F300  ; carregar 50mm devagar
  G1 E30 F150  ; mais 30mm bem devagar para garantir
  G1 E10 F50   ; ultimos 10mm muito devagar
  M82  ; extrusao absoluta
  M117 Filamento carregado
  {action_respond_info('Filamento carregado - total 90mm extrudados')}

[gcode_macro UNLOAD_FILAMENT]
description: Descarregar filamento manualmente
gcode:
  {% set TEMP = params.TEMP|default(200)|float %}
  M117 Aquecendo para descarregar filamento
  M109 S{TEMP}  ; aquecer a temperatura especificada
  M117 Descarregando filamento
  M83  ; extrusao relativa
  G1 E10 F300  ; extrudar um pouco para soltar
  G1 E-15 F1000  ; retracao rapida inicial
  G1 E-80 F800  ; retracao principal mais devagar
  M82  ; extrusao absoluta
  M117 Filamento descarregado
  {action_respond_info('Filamento descarregado - puxe manualmente o restante')}

######################################################################
# Macros de Calibracao
######################################################################
[gcode_macro PID_EXTRUDER]
description: Calibrar PID do extrusor (hotend)
gcode:
  {% set TEMP = params.TEMP|default(200)|float %}
  M117 Calibrando PID extrusor: {TEMP}C
  {action_respond_info('Iniciando calibracao PID do extrusor a ' ~ TEMP|string ~ 'C')}
  PID_CALIBRATE HEATER=extruder TARGET={TEMP}
  M117 PID extrusor calibrado
  {action_respond_info('Calibracao concluida - execute SAVE_CONFIG')}

[gcode_macro PID_BED]
description: Calibrar PID da mesa aquecida
gcode:
  {% set TEMP = params.TEMP|default(60)|float %}
  M117 Calibrando PID mesa: {TEMP}C
  {action_respond_info('Iniciando calibracao PID da mesa a ' ~ TEMP|string ~ 'C')}
  PID_CALIBRATE HEATER=heater_bed TARGET={TEMP}
  M117 PID mesa calibrado
  {action_respond_info('Calibracao concluida - execute SAVE_CONFIG')}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description: Preparar impressora para teste de Pressure Advance
gcode:
  {% set PA_START = params.PA_START|default(0.0)|float %}
  {% set PA_STEP = params.PA_STEP|default(0.005)|float %}
  M117 Teste Pressure Advance
  {action_respond_info('Use o modelo de teste de PA e ajuste manualmente')}
  {action_respond_info('PA inicial: ' ~ PA_START|string ~ ' | Incremento: ' ~ PA_STEP|string)}
  SET_PRESSURE_ADVANCE ADVANCE={PA_START}

######################################################################
# Macros de Estacionamento e Posicionamento do BLTouch
######################################################################

[gcode_macro ESTACIONAR_FRENTE_ESQUERDA]
description: Sobe Z e estaciona no canto frontal esquerdo (X10 Y10)
gcode:
  {% set Z = params.Z|default(10)|float %}
  M117 Estacionando frente-esquerda
  G91
  G1 Z{Z} F3000
  G90
  G1 X10 Y10 F6000
  {action_respond_info('Estacionado em X10 Y10 (frente-esquerda)')}

[gcode_macro ESTACIONAR_TRAS_DIREITA]
description: Sobe Z e estaciona no canto traseiro direito da area de impressao (X290 Y290)
gcode:
  {% set Z = params.Z|default(10)|float %}
  M117 Estacionando tras-direita
  G91
  G1 Z{Z} F3000
  G90
  G1 X290 Y290 F6000
  {action_respond_info('Estacionado em X290 Y290 (tras-direita)')}

# Macros para posicionar o BLTouch diretamente sobre cada parafuso da mesa
# Observacao: coordenadas dos parafusos abaixo sao do [bed_screws]
#   screw1: 29,25 (Frente-Esquerda)
#   screw2: 268,25 (Frente-Direita)
#   screw3: 268,264 (Traseira-Direita)
#   screw4: 29,264 (Traseira-Esquerda)
# Usamos o offset configurado do BLTouch para calcular a posicao do bico.

[gcode_macro BLTOUCH_PARAFUSO_FRONTAL_ESQUERDO]
description: Move o BLTouch sobre o parafuso frontal esquerdo
gcode:
  {% set Z = params.Z|default(5)|float %}
  {% set x_off = printer.configfile.settings.bltouch.x_offset|float %}
  {% set y_off = printer.configfile.settings.bltouch.y_offset|float %}
  {% set sx = 29.0 %}{% set sy = 25.0 %}
  {% set nx = sx - x_off %}{% set ny = sy - y_off %}
  M117 Indo ao parafuso frontal esquerdo
  G91
  G1 Z{Z} F3000
  G90
  G1 X{nx} Y{ny} F6000
  {action_respond_info('BLTouch sobre parafuso frontal esquerdo')}

[gcode_macro BLTOUCH_PARAFUSO_FRONTAL_DIREITO]
description: Move o BLTouch sobre o parafuso frontal direito
gcode:
  {% set Z = params.Z|default(5)|float %}
  {% set x_off = printer.configfile.settings.bltouch.x_offset|float %}
  {% set y_off = printer.configfile.settings.bltouch.y_offset|float %}
  {% set sx = 268.0 %}{% set sy = 25.0 %}
  {% set nx = sx - x_off %}{% set ny = sy - y_off %}
  M117 Indo ao parafuso frontal direito
  G91
  G1 Z{Z} F3000
  G90
  G1 X{nx} Y{ny} F6000
  {action_respond_info('BLTouch sobre parafuso frontal direito')}

[gcode_macro BLTOUCH_PARAFUSO_TRASEIRO_DIREITO]
description: Move o BLTouch sobre o parafuso traseiro direito
gcode:
  {% set Z = params.Z|default(5)|float %}
  {% set x_off = printer.configfile.settings.bltouch.x_offset|float %}
  {% set y_off = printer.configfile.settings.bltouch.y_offset|float %}
  {% set sx = 268.0 %}{% set sy = 264.0 %}
  {% set nx = sx - x_off %}{% set ny = sy - y_off %}
  M117 Indo ao parafuso traseiro direito
  G91
  G1 Z{Z} F3000
  G90
  G1 X{nx} Y{ny} F6000
  {action_respond_info('BLTouch sobre parafuso traseiro direito')}

[gcode_macro BLTOUCH_PARAFUSO_TRASEIRO_ESQUERDO]
description: Move o BLTouch sobre o parafuso traseiro esquerdo
gcode:
  {% set Z = params.Z|default(5)|float %}
  {% set x_off = printer.configfile.settings.bltouch.x_offset|float %}
  {% set y_off = printer.configfile.settings.bltouch.y_offset|float %}
  {% set sx = 29.0 %}{% set sy = 264.0 %}
  {% set nx = sx - x_off %}{% set ny = sy - y_off %}
  M117 Indo ao parafuso traseiro esquerdo
  G91
  G1 Z{Z} F3000
  G90
  G1 X{nx} Y{ny} F6000
  {action_respond_info('BLTouch sobre parafuso traseiro esquerdo')}
